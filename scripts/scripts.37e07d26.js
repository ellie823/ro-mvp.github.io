"use strict";var app=angular.module("roMvpTrackerApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule","firebase","angularMoment","ui.router","ui.bootstrap","angular-loading-bar","angular-web-notification"]);app.config(["$stateProvider","$urlRouterProvider","localStorageServiceProvider",function(a,b,c){c.setPrefix("roMvpTrackerApp"),a.state("mvp",{url:"/",templateUrl:"views/mvp.html"}),b.otherwise("/")}]),app.run(["$rootScope","firebase",function(a,b){a.settings={};var c={apiKey:"AIzaSyBWou-B2GvCKnjXlNQls9plahI0U0f3Y_8",authDomain:"ro-mvp-tracker.firebaseapp.com",databaseURL:"https://ro-mvp-tracker.firebaseio.com",storageBucket:"ro-mvp-tracker.appspot.com"};b.initializeApp(c)}]),app.controller("MvpCtrl",["$scope","$rootScope","$timeout","$state","DataSrv","firebase","$firebaseObject","webNotification","time",function(a,b,c,d,e,f,g,h,i){var j,k,l=function(){a.notifications={},a.updateTimer=null,b.$watch("settings.group",function(b,d){c.cancel(j),b!==d&&(j=c(a.getTrackList,2500))}),a.$watchGroup(["mvpList","trackList"],function(){if("object"==typeof a.mvpList&&"object"==typeof a.trackList){var b,c,d;for(var e in a.mvpList)c=a.mvpList[e],c&&(b=c.id+c.map,d=a.trackList[b],c.$track=d||{});a.update()}}),angular.element(window).bind("keyup",function(b){17===b.keyCode&&(a.ctrlDown=!1)}),angular.element(window).bind("keydown",function(b){17===b.keyCode&&(a.ctrlDown=!0),a.ctrlDown&&70===b.keyCode&&(b.preventDefault(),angular.element("#mvpFilter").focus())}),a.mvpList=e.getMvpList(),i.sync().then(function(){a.getTrackList(),a.update()})};a.orderTrackList=function(a){return a&&"object"==typeof a&&a.$track?(a.$track.$highlight="",a.$track.$respawn?a.$track.$respawn.min<0&&a.$track.$respawn.max<0&&-1*a.$track.$respawn.min>1800?(a.$track.$highlight="stale",-a.$track.$respawn.min):(a.$track.$respawn.min>0&&a.$track.$respawn.min<=300?a.$track.$highlight="warning":a.$track.$respawn.min>0?a.$track.$highlight="":a.$track.$highlight="danger",Number.MIN_SAFE_INTEGER+a.$track.$respawn.min):(a.$track.$highlight="",Number.MAX_SAFE_INTEGER)):void 0},a.getTrackList=function(){if(b.settings.group){k&&k();var c=f.database().ref().child("tracks/"+b.settings.group),d=g(c);a.trackListRef=c,a.trackList=d,d.$bindTo(a,"trackList").then(function(a){k=a})}},a.getTrack=function(b){if("object"==typeof a.trackList){var c=b.id+b.map;return a.trackList[c]||null}return null},a.setTrack=function(c,d){if(!i.isSynced())return void window.alert("Can't set track. Time not synchronized. Please reload the page.");var e=c.id+c.map,f=i.unix();d=d||0,a.trackList[e]={id:c.id,map:c.map,name:b.settings.name,time:f-d}},a.removeTrack=function(a){var c=window.confirm("Do you want to remove this entry?");if(c){var d=a.id+a.map,e=f.database().ref().child("tracks/"+b.settings.group+"/"+d);e.remove(),a.$track={}}},a.update=function(){var d=i.unix();if(i.isSynced())for(var e=function(a,b){a&&window.alert("Unable to show notification: "+a.message)},g=0;g<a.mvpList.length;g++){var j=a.mvpList[g],k=j.id+j.map;if(j&&j.$track&&j.$track.time){var l=Math.round(j.respawn.min-(d-j.$track.time)),m=Math.round(j.respawn.max-(d-j.$track.time));j.$state=!1;var n=60*(b.settings.notificationTime||0);if(0>=l&&0>=m){j.$state=!0;var o=m;m=l,l=o}else n>=l&&b.settings.notificationEnabled&&a.notifications[k]!==j.$track.time&&(h.showNotification("Ragnarok MVP Tracker",{body:j.name+" ("+j.map+") spawns in "+Math.round(l/60)+" to "+Math.round(m/60)+" minutes",icon:"images/mvp.be44a668.png",autoClose:3e4},e),a.notifications[k]=j.$track.time);if(j.$track.$respawn=j.$track.$respawn||{},j.$track.$respawn.min=l,j.$track.$respawn.max=m,-1*m>3.2*j.respawn.max){var p=f.database().ref().child("tracks/"+b.settings.group+"/"+k);p.remove(),j.$track={}}}}c.cancel(a.updateTimer),a.updateTimer=c(a.update,1e3*(20-d%20))},l()}]),app.controller("SettingsCtrl",["$scope","$rootScope","$timeout","$state","$transitions","$firebaseAuth","localStorageService",function(a,b,c,d,e,f,g){var h=function(){a.settingsDropdown=a.settingsDropdown||{},a.notificationTimeList=[1,2,3,4,5];var d;b.$watch("settings",function(){c.cancel(d),d=c(a.save,2e3)},!0),b.$watch("settings.notificationEnabled",function(){Notification&&b.settings.notificationEnabled&&Notification.requestPermission(function(a){"granted"===a?b.settings.notificationEnabled=!0:b.settings.notificationEnabled=!1})});var e;b.$watch("settings.authKey",function(){c.cancel(e),e=c(a.authenticate,2e3)});var g=!1;f().$onAuthStateChanged(function(b){b?(a.settings.$authenticated=!0,g=!1):(a.settings.$authenticated=!1,g||(g=!0,a.authenticate()))}),a.load(),a.authenticate()};a.load=function(){b.settings=g.get("settings")||null,b.settings&&"object"==typeof b.settings||(b.settings={authKey:"",group:"",name:"",notificationEnabled:!1,notificationTime:1},a.settingsDropdown.open=!0),a.settings.$authenticated=!1},a.save=function(){g.set("settings",b.settings)},a.authenticate=function(){var a="ro.mvp.tracker@gmx.de";f().$signInWithEmailAndPassword(a,b.settings.authKey).then(function(a){b.settings.$authenticated=!0})["catch"](function(a){b.settings.$authenticated=!1})},b.isValidSettings=function(){return b.settings.$authenticated&&b.settings.authKey&&b.settings.group&&b.settings.name?!0:!1},h()}]),app.service("DataSrv",function(){var a={};return a.getMvpList=function(){return[{id:1511,map:"moc_pryd06",name:"Amon Ra",respawn:{min:3600,max:4200}},{id:1096,map:"pay_fild04",name:"Angeling",respawn:{min:3600,max:5400}},{id:1096,map:"xmas_dun01",name:"Angeling",respawn:{min:3600,max:5400}},{id:1096,map:"yuno_fild03",name:"Angeling",respawn:{min:3600,max:5400}},{id:1388,map:"yuno_fild05",name:"Archangeling",respawn:{min:3600,max:3780}},{id:1785,map:"ra_fild02",name:"Atroce",respawn:{min:14400,max:15e3}},{id:1785,map:"ra_fild03",name:"Atroce",respawn:{min:10800,max:11400}},{id:1785,map:"ra_fild04",name:"Atroce",respawn:{min:18e3,max:18600}},{id:1785,map:"ve_fild01",name:"Atroce",respawn:{min:10800,max:11400}},{id:1785,map:"ve_fild02",name:"Atroce",respawn:{min:21600,max:22200}},{id:1630,map:"lou_dun03",name:"White Lady",respawn:{min:7020,max:7620}},{id:1039,map:"prt_maze03",name:"Baphomet",respawn:{min:7200,max:7800}},{id:1873,map:"abbey03",name:"Beelzebub",respawn:{min:43200,max:43800}},{id:1646,map:"lhz_dun03",name:"Lord Knight Seyren",respawn:{min:6e3,max:7800}},{id:1647,map:"lhz_dun03",name:"Assassin Cross Eremes",respawn:{min:6e3,max:7800}},{id:1648,map:"lhz_dun03",name:"Whitesmith Howard",respawn:{min:6e3,max:7800}},{id:1649,map:"lhz_dun03",name:"High Priest Margaretha",respawn:{min:6e3,max:7800}},{id:1650,map:"lhz_dun03",name:"Sniper Cecil",respawn:{min:6e3,max:7800}},{id:1651,map:"lhz_dun03",name:"High Wizard Kathryne",respawn:{min:6e3,max:7800}},{id:2068,map:"bra_dun02",name:"Boitata",respawn:{min:7200,max:7800}},{id:1272,map:"gld_dun04",name:"Dark Lord",respawn:{min:28800,max:29400}},{id:1272,map:"gl_chyard",name:"Dark Lord",respawn:{min:3600,max:4200}},{id:1719,map:"abyss_03",name:"Detale",respawn:{min:10800,max:11400}},{id:1582,map:"pay_fild04",name:"Deviling",respawn:{min:7200,max:10800}},{id:1582,map:"yuno_fild03",name:"Deviling",respawn:{min:3600,max:5400}},{id:1046,map:"gef_dun02",name:"Doppelganger",respawn:{min:7200,max:7800}},{id:1046,map:"gld_dun02",name:"Doppelganger",respawn:{min:28800,max:29400}},{id:1389,map:"gef_dun01",name:"Dracula",respawn:{min:3600,max:4200}},{id:1112,map:"treasure02",name:"Drake",respawn:{min:7200,max:7800}},{id:1115,map:"gld_dun01",name:"Eddga",respawn:{min:28800,max:29400}},{id:1115,map:"pay_fild11",name:"Eddga",respawn:{min:7200,max:7800}},{id:1652,map:"lhz_dun02",name:"Egnigem Cenia",respawn:{min:7200,max:7800}},{id:1418,map:"gon_dun03",name:"Evil Snake Lord",respawn:{min:5640,max:6240}},{id:1871,map:"abbey02",name:"Fallen Bishop Hibram",respawn:{min:7200,max:7800}},{id:1252,map:"xmas_fild01",name:"Garm",respawn:{min:7200,max:7800}},{id:1120,map:"gld_dun04",name:"Ghostring",respawn:{min:14400,max:21600}},{id:1120,map:"pay_fild04",name:"Ghostring",respawn:{min:3600,max:5400}},{id:1120,map:"prt_maze03",name:"Ghostring",respawn:{min:6780,max:10200}},{id:1120,map:"treasure02",name:"Ghostring",respawn:{min:1980,max:3180}},{id:1768,map:"ra_san05",name:"Gloom Under Night",respawn:{min:18e3,max:18600}},{id:1086,map:"prt_sewb4",name:"Golden Thief Bug",respawn:{min:3600,max:4200}},{id:1885,map:"mosk_dun03",name:"Gopinich",respawn:{min:7200,max:7800}},{id:1990,map:"man_fild03",name:"Hardrock Mammoth",respawn:{min:14400,max:14460}},{id:1832,map:"thor_v03",name:"Ifrit",respawn:{min:39600,max:40200}},{id:1492,map:"ama_dun03",name:"Incantation Samurai",respawn:{min:5460,max:6060}},{id:1734,map:"kh_dun02",name:"Kiel D-01",respawn:{min:7200,max:10800}},{id:2202,map:"iz_dun05",name:"Kraken",respawn:{min:7200,max:7800}},{id:1779,map:"ice_dun03",name:"Ktullanux",respawn:{min:7200,max:7260}},{id:1688,map:"ayo_dun02",name:"Lady Tanee",respawn:{min:25200,max:25800}},{id:2156,map:"dew_dun01",name:"Leak",respawn:{min:7200,max:7800}},{id:1373,map:"niflheim",name:"Lord of Death",respawn:{min:7980,max:8040}},{id:1147,map:"anthell02",name:"Maya",respawn:{min:7200,max:7800}},{id:1147,map:"gld_dun03",name:"Maya",respawn:{min:28800,max:29400}},{id:1289,map:"anthell01",name:"Maya Purple",respawn:{min:7200,max:10800}},{id:1289,map:"gld_dun03",name:"Maya Purple",respawn:{min:1200,max:1800}},{id:1059,map:"mjolnir_04",name:"Mistress",respawn:{min:7200,max:7800}},{id:1150,map:"pay_dun04",name:"Moonlight Flower",respawn:{min:3600,max:4200}},{id:1087,map:"gef_fild02",name:"Orc Hero",respawn:{min:86400,max:87e3}},{id:1087,map:"gef_fild14",name:"Orc Hero",respawn:{min:3600,max:4200}},{id:1190,map:"gef_fild10",name:"Orc Lord",respawn:{min:7200,max:7800}},{id:1038,map:"moc_pryd04",name:"Osiris",respawn:{min:3600,max:10800}},{id:1157,map:"in_sphinx5",name:"Pharaoh",respawn:{min:3600,max:4200}},{id:1159,map:"moc_fild17",name:"Phreeoni",respawn:{min:7200,max:7800}},{id:2087,map:"dic_dun02",name:"Queen Scaraba",respawn:{min:7200,max:7260}},{id:2165,map:"dic_dun03",name:"Gold Queen Scaraba",respawn:{min:7200,max:7260}},{id:1623,map:"ein_dun02",name:"RSX-0806",respawn:{min:7500,max:8100}},{id:1251,map:"xmas_dun02",name:"Stormy Knight",respawn:{min:3600,max:4200}},{id:1583,map:"beach_dun",name:"Tao Gunka",respawn:{min:18e3,max:18600}},{id:1583,map:"beach_dun2",name:"Tao Gunka",respawn:{min:18e3,max:18600}},{id:1583,map:"beach_dun3",name:"Tao Gunka",respawn:{min:18e3,max:18600}},{id:1991,map:"spl_fild03",name:"Tendrillion",respawn:{min:3600,max:3660}},{id:1708,map:"thana_boss",name:"Thanatos",respawn:{min:7200,max:7260}},{id:1312,map:"tur_dun04",name:"Turtle General",respawn:{min:3600,max:4200}},{id:1751,map:"odin_tem03",name:"Valkyrie Randgris",respawn:{min:28800,max:50400}},{id:1685,map:"jupe_core",name:"Vesper",respawn:{min:7200,max:7800}},{id:1917,map:"moc_fild22",name:"Wounded Morroc",respawn:{min:43200,max:54e3}}]},a}),app.filter("ceil",function(){return function(a){return Math.ceil(a)}}),app.service("time",["$rootScope","$http",function(a,b){var c={},d=0,e=0,f=!1;return c.sync=function(){return b.get("https://ntp-a1.nict.go.jp/cgi-bin/json").then(function(a){e=Math.floor(a.data.st),d=Math.floor((new Date).getTime()/1e3),f=!0})["catch"](function(a){f=!1})},c.isSynced=function(){return f},c.unix=function(){var a=Math.floor((new Date).getTime()/1e3);if(!f)return a;var b=a-d,c=e+b;return c},c}]),angular.module("roMvpTrackerApp").run(["$templateCache",function(a){a.put("views/mvp.html",'<div ng-controller="MvpCtrl" ng-if="isValidSettings()"> <div class="input-group mvp-filter pull-right"> <input id="mvpFilter" type="text" class="form-control form-control-sm" placeholder="Search" ng-class="{\'rounded\': !mvpFilter}" ng-model="mvpFilter"> <span class="input-group-btn" ng-show="mvpFilter"> <button class="btn btn-default" type="button" ng-click="mvpFilter=\'\'"> <span class="glyphicon glyphicon-remove"></span> </button> </span> </div> <table class="table table-striped mvp-list"> <thead> <tr> <td width="30%">MVP</td> <td width="50%">Spawn Time</td> <td width="20%">Update</td> </tr> </thead> <tbody> <tr ng-repeat="mvp in (mvpList | filter:mvpFilter | orderBy:orderTrackList)" ng-class="mvp.$track.$highlight"> <td> <div> <span class="mvp-name"><a href="https://panel.talonro.com/mobdb/{{mvp.id}}/" target="_blank">{{mvp.name}}</a></span> <small>(<a href="http://ratemyserver.net/index.php?page=npc_shop_warp&map={{mvp.map}}" target="_blank">{{mvp.map}}</a>)</small> </div> <div><small>{{mvp.respawn.min / 60 | ceil | number:0}} – {{mvp.respawn.max / 60 | ceil | number:0}} Minutes</small></div> </td> <td> <div ng-if="mvp.$track.$respawn"> <div> <span>{{mvp.$state ? \'\' : \'in\'}}</span> <strong> <span ng-class="mvp.$track.$respawn.min > 0 ? \'text-success\' : \'text-danger\'"> {{mvp.$state ? (((-1 * mvp.$track.$respawn.min) / 60) | ceil | number:0) : ((mvp.$track.$respawn.min / 60) | ceil | number:0)}} </span> </strong> minutes to <strong> <span ng-class="mvp.$track.$respawn.max > 0 ? \'text-success\' : \'text-danger\'"> {{mvp.$state ? (((-1 * mvp.$track.$respawn.max) / 60) | ceil | number:0) : ((mvp.$track.$respawn.max / 60) | ceil | number:0)}} </span> </strong> minutes <span>{{mvp.$state ? \'ago\' : \'\'}}</span> </div> <div>last tracked <span am-time-ago="mvp.$track.time * 1000"></span> by <strong>{{mvp.$track.name}}</strong></div> </div> <div ng-if="!mvp.$track.$respawn">–</div> </td> <td> <form class="form-inline" role="form"> <div class="input-group input-group-sm group-track"> <input type="text" class="form-control form-control-sm" ng-init="ago=0" ng-blur="!ago ? ago=0 : ago=ago" ng-model="ago"> <span class="ago"></span> <span class="input-group-btn"> <button class="btn btn-default btn-sm" type="button" ng-click="setTrack(mvp, ago * 60); ago=0;"> <span class="glyphicon glyphicon-share-alt"></span> </button> </span> </div> <div class="form-group" ng-if="mvp.$track.$respawn"> <button class="btn btn-default btn-sm" type="button" ng-click="removeTrack(mvp)"> <span class="glyphicon glyphicon-remove"></span> </button> </div> </form> </td> </tr> </tbody> </table> </div>'),a.put("views/settings.html",'<form class="form-horizontal" ng-controller="SettingsCtrl"> <!-- authentication key--> <div class="form-group" ng-class="(!settings.authKey || !settings.$authenticated) ? \'invalid\' : \'\'"> <label class="col-md-12 control-label" for="authKey">Authentication Key <small><span class="glyphicon glyphicon-lock"></span></small></label> <div class="col-md-12"> <div class="input-group"> <input id="authKey" name="authKey" type="text" placeholder="" class="form-control input-md" ng-model="settings.authKey"> <span class="input-group-btn"> <span name="auth" class="btn btn-default" ng-class="!settings.$authenticated ? \'btn-danger\' : \'btn-success\'"> <span class="glyphicon" ng-class="!settings.$authenticated ? \'glyphicon-remove\' : \'glyphicon-ok\'"></span> </span> </span> </div> </div> </div> <!-- group--> <div class="form-group" ng-class="!settings.group ? \'invalid\' : \'\'"> <label class="col-md-12 control-label" for="group">Group</label> <div class="col-md-12"> <input id="group" name="group" type="text" placeholder="" class="form-control input-md" ng-model="settings.group"> </div> </div> <!-- name--> <div class="form-group" ng-class="!settings.name ? \'invalid\' : \'\'"> <label class="col-md-12 control-label" for="name">Name</label> <div class="col-md-12"> <input id="name" name="name" type="text" placeholder="" class="form-control input-md" ng-model="settings.name"> </div> </div> <!-- notification--> <div class="form-group"> <label class="col-md-12 control-label" for="">Notification</label> <div class="col-md-12"> <label class="checkbox-inline" for="notification"> <input type="checkbox" id="notification" name="notification" value="1" ng-model="settings.notificationEnabled"> Notify <span class="form-inline"> <select class="form-control input-xs notification-time" ng-model="settings.notificationTime" ng-options="value*1 for (key, value) in notificationTimeList"></select> </span> minute(s) before spawn </label> </div> </div> </form>')}]);